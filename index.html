<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Laboratorio de Suelos JCH</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;font-family:Arial,Helvetica,sans-serif;}
    .hero{
      background:#111 url('https://laboratoriodesuelosjch.github.io/img/back-1.jpg') no-repeat center/cover;
      height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
    }
    .overlay{position:absolute;inset:0;background:rgba(0,0,0,.6)}
    .content{position:relative;z-index:2;color:#fff;text-align:center;padding:1rem}
    
    /* Animación para el título */
    h1{
      font-size:2.5rem;
      letter-spacing:.05em;
      opacity:0;
      transform:translateY(-20px);
      animation:fadeDown 1s ease forwards;
    }
    @keyframes fadeDown {
      to { opacity:1; transform:translateY(0); }
    }

    .loader{
      position:absolute;
      top:2rem;left:50%;
      transform:translateX(-50%);
      z-index:3
    }

    .message{
      margin-top:1.25rem;
      font-size:1rem;
      opacity:0;
      transition:opacity .5s ease;
    }
    .message.show{opacity:1}
    .message.ok{color:#fff}
    .message.error{color:#ffb3b3}

    .btn{
      display:inline-block;
      margin-top:1rem;
      padding:.5rem 1rem;
      border-radius:6px;
      border:0;
      background:#FF6B35;
      color:#fff;
      cursor:pointer;
      opacity:0;
      transition:opacity .5s ease;
    }
    .btn.show{opacity:1}

    .hidden{display:none}

    @media(max-width:600px){
      h1{font-size:1.6rem}
    }
  </style>
</head>
<body>
  <main class="hero" role="main" aria-live="polite">
    <div class="overlay"></div>

    <div class="loader" id="loader" aria-hidden="false">
      <!-- spinner simple -->
      <svg width="48" height="48" viewBox="0 0 50 50" aria-hidden="true">
        <circle cx="25" cy="25" r="20" stroke="currentColor" stroke-width="4" fill="transparent" stroke-linecap="round" stroke-dasharray="31.4 31.4">
          <animateTransform attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="1s" repeatCount="indefinite" />
        </circle>
      </svg>
    </div>

    <section class="content">
      <h1>Laboratorio de Suelos JCH</h1>
      <div class="message" id="message">Verificando código...</div>
      <button id="goBase" class="btn hidden" aria-label="Ir a la página principal">Ir a la página principal</button>
    </section>
  </main>

  <script>
    const AS_URL_BASE = "https://script.google.com/macros/s/AKfycbxwz4nI6XoJbJpAtDEVKcH1mbk7mjonZ9L36QcL0bmhaWq5U01sPHR6BjtUu70qEpEM/exec";

    const loader = document.getElementById('loader');
    const messageEl = document.getElementById('message');
    const goBaseBtn = document.getElementById('goBase');

    function showMessage(text, type="ok") {
      loader.classList.remove('hidden');
      messageEl.textContent = text || '';
      messageEl.className = `message show ${type}`;
    }

    function hideLoader() {
      loader.classList.add('hidden');
    }

    function showGoBase() {
      goBaseBtn.classList.remove('hidden');
      requestAnimationFrame(()=> goBaseBtn.classList.add('show'));
      goBaseBtn.onclick = () => { window.location.href = '/'; };
    }

    (async function main(){
      try {
        const params = new URLSearchParams(window.location.search);
        const k = params.get('k');
        if (!k) {
          showMessage('No se encontró el parámetro "k" en la URL.', "error");
          hideLoader();
          showGoBase();
          return;
        }

        showMessage('Buscando destino para el código...');
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 6000);

        const resp = await fetch(`${AS_URL_BASE}?k=${encodeURIComponent(k)}`, {
          method: 'GET',
          signal: controller.signal,
          cache: 'no-store'
        });
        clearTimeout(timeout);

        if (!resp.ok) {
          showMessage('Error en la comunicación con el servicio. Inténtalo de nuevo.', "error");
          hideLoader();
          showGoBase();
          return;
        }

        const data = await resp.json();
        if (data && data.ok && data.url) {
          showMessage('Redirigiendo...', "ok");
          window.location.replace(data.url);
          return;
        } else {
          const err = (data && data.error) ? data.error : 'URL no encontrada';
          showMessage('No se encontró la URL asociada: ' + err, "error");
          hideLoader();
          showGoBase();
        }

      } catch (err) {
        if (err.name === 'AbortError') {
          showMessage('Tiempo de espera agotado. Inténtalo de nuevo.', "error");
        } else {
          showMessage('Ocurrió un error: ' + (err.message || err), "error");
        }
        hideLoader();
        showGoBase();
      }
    })();
  </script>

  <noscript>
    <meta http-equiv="refresh" content="5;url=/">
    <div style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#111;color:#fff;">
      Esta página requiere JavaScript para redirigir. Serás llevado a la página principal en 5s.
    </div>
  </noscript>
</body>
</html>
